{"version":3,"sources":["view_manager.js"],"names":["vm","_zorder","_cacheArr","_activeArr","_waitArr","init","openPrefab","assetUrl","params","parentReal","callback","scene","_checkScene","cc","error","parent","pos","v2","node","_checkCache","warn","_showPrefab","setPosition","prefab","loader","getRes","_addPrefab","loadRes","Prefab","completedCount","totalCount","err","isValid","_pushCache","k","log","name","_clearCache","zIndex","_getZorder","active","_actComp","instantiate","scripts","getComponents","Component","filter","component","__classname__","indexOf","i","length","script","_checkActivePop","openQueuePrefab","item","_pushWait","push","len","_quietLoadAsset","popWait","shift","checkActivePop","getComponent","popArr","children","child","sort","compa","compb","comp","resetOpacity","dialog","arr","na","nb","pop","_checkDeadPop","splice","director","getScene","GM","module","exports"],"mappings":"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","file":"view_manager.js","sourceRoot":"../../../../../assets/Script/Comps","sourcesContent":["/*\n* 1. 网络连接菊花\n* 2. 预制体加载进入菊花\n* 3. 重要确定弹窗 \n*\t以上全部在最上层\n*/\nlet vm = {\n    _zorder:100,\n    _cacheArr:{},  // 已经缓存过的预制体  key(url)  value(当前节点)     ok\n    _activeArr:{}, // 当前父节点激活的 子节点 key(父节点) value([显示队列]) 需要在激活时，隐藏销毁时，检查下 ok\n    _waitArr:[],   // 当前在等待显示的队列。\n    \t\n\tinit(){\n\t}, \t\n\n    /*\n    *\tassetUrl: 预制体路径,\n    *\tparams: 所需参数,\n    *\tparent: 当前Node父节点\n    */\n    openPrefab(assetUrl,params,parentReal,callback){\n    \tlet scene = this._checkScene();\n    \tif(!scene){ cc.error('VM not scene'); return;}\n    \tlet parent = parentReal || scene;\n        let pos = parentReal ? cc.v2(0,0) : cc.v2(568,320);\n    \tlet node = this._checkCache(assetUrl);\n    \tif(node){\n    \t\t// TODO 直接激活节点\n            cc.warn('VM getCache',assetUrl);\n    \t\tthis._showPrefab(node,params,parent,assetUrl);\n            node.setPosition(pos);\n            callback && callback();\n    \t\treturn;\n    \t}\n    \tlet prefab = cc.loader.getRes(assetUrl);\n    \tif(prefab){\n    \t\t// TODO \n            cc.warn('VM getRes',assetUrl);\n\t\t\tnode = this._addPrefab(prefab,params,parent,assetUrl);\n            node.setPosition(pos);\n            callback && callback();\n\t\t\treturn;\n    \t}\n        cc.warn('VM loadRes',assetUrl);\n    \tcc.loader.loadRes(assetUrl,cc.Prefab,(completedCount, totalCount)=>{\n    \t\t// TODO 加载进度更新\n\n    \t},(err,prefab)=>{\n    \t\t// TODO 加载更新完成\n\n    \t\tif(err){\n    \t\t\t// TODO 发生错误\n    \t\t\treturn;\n    \t\t}\n    \t\tnode = this._addPrefab(prefab,params,parent,assetUrl);\n            node.setPosition(pos);\n            callback && callback();\n    \t});\n    },\n\n    /*\n    * vm_cache {url1:{name1:parent1,name2:parent2},url2:{name1:parent1}}\n    */\n    _checkCache(assetUrl){\n        let node = this._cacheArr[assetUrl];\n        if(node){\n            if(!cc.isValid(node)){\n                return null;\n            }\n            return node;\n        }\n        return null;\n    },\n    _pushCache(assetUrl,node){  \n        this._cacheArr[assetUrl] = node;\n\n        // 测试打印\n        for(let k in this._cacheArr){\n            cc.log('VM ','url:'+k,'name:'+this._cacheArr[k].name); // node name\n        }\n    },\n    _clearCache(assetUrl){\n        if(assetUrl){\n            delete this._cacheArr[assetUrl];\n            return;\n        }\n        this._cacheArr = {};\n    },\n\n    /*\n    *    激活显示当前预制体\n    */\n    _showPrefab(node,params,parent,assetUrl){\n        if(node.parent != parent){\n            node.parent = parent;\n        }\n\t\tnode.zIndex = this._getZorder();\n\t\tnode.active = true;\n        this._actComp(node,params,assetUrl);\n        return node;\n    },\n    _addPrefab(prefab,params,parent,assetUrl){\n    \tlet node = cc.instantiate(prefab);\n    \tnode.zIndex = this._getZorder();\n        node.parent = parent;\n        this._actComp(node,params,assetUrl);\n        return node;\n    },\n    _actComp(node,params,assetUrl){\n        let scripts = node.getComponents(cc.Component).filter(function (component) {\n            return component.__classname__.indexOf('cc.') !== 0;\n        });\n        for(let i = 0; i < scripts.length; i++){\n            let script = scripts[i];\n            script.init && script.init(params);\n        }\n        this._pushCache(assetUrl,node);\n\n        // 做一些check\n        this._checkActivePop(node);\n        \n\n        // 测试打印\n        // let scene = this._checkScene();\n        // for(let i = 0; i < scene.children.length; i++){\n        //     let child = scene.children[i];\n        //     cc.error('current scene child-',child.name,child.zIndex);\n        // }\n        \n    },\n\n    /*\n    *    等待预制队列\n    */\n    openQueuePrefab(assetUrl,params,parentReal,callback){\n        let item = {\n            assetUrl:assetUrl,\n            params:params,\n            parentReal:parentReal,\n            callback:callback,\n        };\n        this._pushWait(item);\n        if(this._waitArr.length == 1){\n            this.openPrefab(assetUrl,params,parentReal,callback);\n        }\n    },\n    _pushWait(item){\n        this._waitArr.push(item);\n        if(this._waitArr.length > 1){\n            let len = this._waitArr.length;\n            let item = this._waitArr[len-1];\n            this._quietLoadAsset(item.assetUrl);\n        }\n    },\n    popWait(){\n        this._waitArr.shift();\n        if(this._waitArr.length > 0){\n            let item = this._waitArr[0];\n            this.openPrefab(item.assetUrl,item.params,item.parentReal,item.callback);\n        }\n    },\n\n    /*\n    *    当前激活队列\n    */\n    checkActivePop(node){\n        if(!node.getComponent('dialog_comp')){return;}\n        let parent = node.parent;\n        let popArr = [];\n        for(let i = 0; i < parent.children.length; i++){\n            let child = parent.children[i];\n            if(child.active && child.getComponent('dialog_comp')){\n                popArr.push(child.getComponent('dialog_comp'));\n            }\n        }\n        let len = popArr.length;\n        if(len > 1){\n            popArr.sort((compa,compb)=>{\n                return compb.node.zIndex - compa.node.zIndex; //降序 105,104,103,102\n            });\n            for(let i = 1; i < popArr.length; i++){\n                let comp = popArr[i];\n                comp.resetOpacity(0);\n                cc.error(comp.name,comp.node.zIndex);\n            }\n        }\n        if(popArr[0]){popArr[0].resetOpacity();}\n    },\n    _checkActivePop(node){\n        if(!node.dialog){return;}\n        let parent = node.parent;\n        let arr = this._activeArr[parent.name] || [];\n        arr.push(node);\n        if(arr.length == 1){\n            arr[0].dialog.resetOpacity();\n            this._activeArr[parent.name] = arr;\n            return;\n        }\n        arr.sort((na,nb)=>{\n            return nb.zIndex - na.zIndex; //降序 105,104,103,102\n        });\n        for(let i = 1; i < arr.length; i++){\n            let pop = arr[i];\n            pop.dialog.resetOpacity(0);\n        }\n        arr[0].dialog.resetOpacity();\n    },\n    _checkDeadPop(node){\n        this.popWait();\n        if(!node.dialog){return;}\n        let parent = node.parent;\n        let arr = this._activeArr[parent.name] || [];\n        for(let i = 0; i < arr.length; i++){\n            if(arr[i] == node){\n                arr.splice(i,1);\n                break;\n            }\n        }\n        arr.sort((na,nb)=>{\n            return nb.zIndex - na.zIndex; //降序 105,104,103,102\n        });\n        if(arr[0]){arr[0].dialog.resetOpacity();}\n        this._activeArr[parent.name] = arr;\n    },\n\n    /*\n    *  辅助类\n    */\n    _checkScene(){\n        let scene = cc.director.getScene();\n        return scene;\n    },\n    _getZorder(){\n        return this._zorder++;\n    },\n\n    /*\n    * 静默加载预制体。\n    */\n    _quietLoadAsset(assetUrl){\n        if(cc.loader.getRes(assetUrl)){return;}\n    \tcc.loader.loadRes(assetUrl, (error,prefab)=>{});\n    },\n};\nGM.vm = module.exports = vm;"]}